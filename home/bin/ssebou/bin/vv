#!/usr/bin/env bash
# Call recently edited by vim allowing to select with fzf
# set -x
[[ -z "$1" ]] || HSELOPT=(-1 -q "$*")

TF1=$(mktemp -u)
#TF2=$(mktemp -u)
trap 'rm $TF1' EXIT


vim -c ':exe "redir => m | silent browse old | redir END | put=m"' -c ":w $TF1" -c ":q"

# TODO PREVENIVE CHECK FOR FILE EXISTANCE AND MARK THE ENTRIES THAT DO
# NOT EXIST ANYMORE
# sed '/^[0-9]*:/!d;' "$TF1"| awk 

#export FZF_DEFAULT_OPTS="--exact --tiebreak=begin --color=dark,hl:220,hl+:226,fg:86,bg+:244,fg+:84                   --bind=*:toggle,alt-j:jump-accept  -m"
export FZF_DEFAULT_OPTS="--exact --tiebreak=begin --color=dark,hl:220,hl+:226,fg:36,bg+:240,fg+:86                   --bind=*:toggle,alt-j:jump-accept  -m"
TFN=$(sed '/^[0-9]*:/!d;' $TF1  | fzf --header="<< files recently edited by vim, select and Enter to open again" +s "${HSELOPT[@]}"| sed 's/^[^:]*:\s*//' ) 
EFN=$(eval echo "$TFN")   # spaces NOT escaped in the filename
QFN=$(printf "%q" "$EFN") # spaces ARE escaped in the filename
FN=$QFN
echo EFN is "[$EFN]"
echo FN is "[$FN]"
# printf -v FN '%q' "$EFN"
if [[ ! "$EFN" =~ ^(scp|zipfile):/.*$ ]]
 then

  if [[ -f "$EFN" ]] # not quoting var in comparison as it is already formatted with q format above
  then 
   vim "$EFN"
  else 
 exit
   [[ ! -z "$EFN" ]] && { >&2 echo "FILE IS NOT(anymore?) THERE: $EFN "; exit 1; }
  fi 
 else 
	 if [[ "$EFN" =~ ^zipfile:/.*$ ]]
	 then 
	  ##echo ZIP file may be there yet
	  TESTC=$(eval echo "$FN" | sed 's|^zipfile:\(.*\)::.*$|stat \1|')
	  eval $TESTC >/dev/null && { vim $FN; } || { >&2 echo ARCHIVE FILE IS NOT HERE FOR: $FN; exit 1; }
	 fi
	 if [[ $EFN =~ ^scp://.*$ ]]
	 then 
	  ##echo Remote file may take longer to open
          ## here is how to insert single quote in sed replace part :echo "hereQpls" | sed 's/Q/'\''/'
	  TESTC=$(eval echo $EFN | sed 's|^scp://|ssh |;s|//\(.*\)$| " stat '\''/\1'\''"|;')
	  eval $TESTC >/dev/null && { vim "$EFN"; } || { >&2 echo FAILED TO REACH: "$FN"; exit 1; }
	 fi
fi
