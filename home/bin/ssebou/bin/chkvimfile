#!/bin/bash

# PURPOSE: to be called from au in vim on buffer exit to save either/or
# - content of the buffer (when vim used as an external editor from browser)
# - file name for the history of recent used

# script supposed to work on both local and remote same way

LOCALVIMHIST=${ONTO4_DRCMDHIST:-/tmp}/${HOSTNAME} # this is for local
# file history to be saved in the same file name as command history, but diffrent extention
VIMRUEXT=${ONTO4_HEEXT:-vimru} #ONTO4_HEEXT can be defined locally, then it will be used to name local history files

BFILE="${@:-NooNxe}"

#Regexp to ignore 
IGNOREG='^/tmp/tmp\..*$
^EMPTYY$
^XScratch.*$'

# if name matches ignore list, do nothing, exit
grep -qf <(for re in $IGNOREG; do printf "%s\n" $re; done) <<<"$BFILE"  && { echo match ; exit 0; }


if [[ "${BFILE}" =~  ^/tmp/bash-fc\..* ]] 
then 
  # save content 
  # CtrlXCtrE was used
  cat "$BFILE" >> /tmp/ctrlXE
elif  [[ "${BFILE}" =~  ^/tmp/editserver/.* ]] 
then
  # saving content to prevent loose of it when emacsedit fails
  VIMBAK=${HISTKEEP3:-${LOCALVIMHIST}}.editserver.$(date --iso-8601='seconds') # HISTKEEP3 only defined remotely, thus VIMBAK is defined appropriately
  cat "$BFILE" > "${VIMBAK}"
else 
  if [[ "${BFILE}" =~  ^/tmp/tmp\.* ]] 
  then
   # so far ignore any other tmp.* patterns
   :
  else
    # saving file name in history
    VIMHIST=${HISTKEEP3:-${LOCALVIMHIST}}.${VIMRUEXT}
    echo "$(date --iso-8601='seconds') ${BFILE}">>${VIMHIST} # HISTKEEP3 only defined remotely, thus VIMHIST is defined appropriately
  fi
fi

