#!/bin/bash

# PURPOSE: to be called from au in vim on buffer exit to save either/or
# - content of the buffer (when vim used as an external editor from browser)
# - file name for the history of recent used

# script supposed to work on both local and remote same way

LOCALVIMHIST=${ONTO4_DRCMDHIST:-/tmp}/${HOSTNAME} # this is for local
# file history to be saved in the same file name as command history, but diffrent extention
VIMRUEXT=${ONTO4_HEEXT:-vimru} #ONTO4_HEEXT can be defined locally, then it will be used to name local history files

if [[ ${1:-NooNxe} =~  ^/tmp/bash-fc\..* ]] 
then 
  # save content 
  # CtrlXCtrE was used
  cat $1 >> /tmp/ctrlXE
elif  [[ ${1:-NooNxe} =~  ^/tmp/editserver/.* ]] 
then
  # saving content to prevent loose of it when emacsedit fails
  VIMBAK=${HISTKEEP3:-${LOCALVIMHIST}}.editserver.$(date --iso-8601='seconds') # HISTKEEP3 only defined remotely, thus VIMBAK is defined appropriately
  cat "${1}" > "${VIMBAK}"
else 
  if [[ ${1:-NooNxe} =~  ^/tmp/tmp\.* ]] 
  then
   # so far ignore any other tmp.* patterns
   :
  else
    # saving file name in history
    VIMHIST=${HISTKEEP3:-${LOCALVIMHIST}}.${VIMRUEXT}
    echo "$(date --iso-8601='seconds') ${1:-Nofile}">>${VIMHIST} # HISTKEEP3 only defined remotely, thus VIMHIST is defined appropriately
  fi
fi

